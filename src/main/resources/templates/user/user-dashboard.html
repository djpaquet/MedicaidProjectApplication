<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head th:replace="~{fragments :: head}"></head>
<body>
<!-- Navbar -->
<nav>
    <a class="navbar-brand" th:href="@{/user/user-dashboard}">Dashboard</a>
    <a class="navbar-brand" th:href="@{/user/user-employment-verification-form}">Employment Verification</a>
    <a class="nav-link" th:href="@{/user/logout}">Log Out</a>
</nav>
<header>
    <h1>Welcome, <span th:text="${user.firstName}">User</span>!</h1>
</header>
<!-- Form to update User + Address -->
<div class="form-container">
    <form id="userForm" th:action="@{/user/user-dashboard/save}" method="post" novalidate>
        <div class="InfoList">
            <!-- User Info -->
            <div class="InfoListCategory">
                <h2>Contact Information:</h2>
                <div class="InfoListItem">
                    <p>Email:
                        <span class="view-mode" th:text="${user.email}">email@example.com</span>
                    </p>
                    <input class="edit-mode" type="email" name="email"
                           th:value="${user.email}" style="display:none;" required
                           th:classappend="${userEmailError} ? ' error'">
                    <div class="error-message" th:if="${userEmailError}" th:text="${userEmailError}"></div>
                </div>
                <div class="InfoListItem">
                    <p>Phone:
                        <span class="view-mode" th:text="${user.phone}">(000) 000-0000</span>
                    </p>
                    <input class="edit-mode" type="text" name="phone"
                           th:value="${user.phone}" style="display:none;" required
                           pattern="^\d{10}$" placeholder="1234567890">
                    <div class="error-message"></div>
                </div>
            </div>
            <!-- Personal Info -->
            <div class="InfoListCategory">
                <h2>Personal Details:</h2>
                <div class="InfoListItem">
                    <p>First Name:
                        <span class="view-mode" th:text="${user.firstName}">First</span>
                    </p>
                    <input class="edit-mode" type="text" name="firstName"
                           th:value="${user.firstName}" style="display:none;" required>
                    <div class="error-message"></div>
                </div>
                <div class="InfoListItem">
                    <p>Last Name:
                        <span class="view-mode" th:text="${user.lastName}">Last</span>
                    </p>
                    <input class="edit-mode" type="text" name="lastName"
                           th:value="${user.lastName}" style="display:none;" required>
                    <div class="error-message"></div>
                </div>
                <div class="InfoListItem">
                    <p>Date of Birth:
                        <span class="view-mode"
                              th:text="${#temporals.format(user.dateOfBirth, 'MM/dd/yyyy')}">01/01/1990</span>
                    </p>
                    <input class="edit-mode" type="date" name="dateOfBirth"
                           th:value="${user.dateOfBirth}" style="display:none;" required>
                    <div class="error-message"></div>
                </div>
                <!-- PIN Field -->
                <div class="InfoListItem">
                    <p>Personal ID (SSN or ARN):</p>
                    <!-- PIN Field Wrapper -->
                    <div class="pin-wrapper">
                        <!-- PIN Container: View Mode (Masked PIN) and Edit Mode (Input) -->
                        <div class="pin-container">
                            <!-- View Mode Masked PIN -->
                            <span id="maskedId" class="masked-id"
                                  th:attr="data-full-id=${user.pin}, data-last4=${#strings.substring(user.pin, user.pin.length() - 4)}">
                           ***-**-
                           <span th:text="${#strings.substring(user.pin, user.pin.length() - 4)}">1234</span>
                           </span>
                            <!-- Edit Mode Input (Initially hidden) -->
                            <input class="edit-mode" type="password" id="editPin" name="pin"
                                   th:value="${user.pin}" required pattern="\d{9}" minlength="9" maxlength="9"
                                   style="display:none;" th:classappend="${pinError} ? ' error'"/>
                            <!-- Eye Icon (For toggling visibility) -->
                            <i class="bi bi-eye-slash" id="togglePassword" style="cursor: pointer;"></i>
                        </div>

                    </div>
                    <!-- Error message below -->
                    <div class="error-message" th:if="${pinError}" th:text="${pinError}"></div>

                 </div>
             </div>
             <!-- Address Fields -->
            <div class="InfoListCategory">
                <h2>Address:</h2>
                <p th:if="${address == null}" style="color: red; font-weight: bold;">
                    Your address is missing. Please fill in your address below.
                </p>
                <div class="InfoListItem">
                    <p>Street Address:
                        <span class="view-mode" th:text="${address != null ? address.street : ''}">123 Main St</span>
                    </p>
                    <input class="edit-mode" type="text" name="street"
                           th:value="${address != null ? address.street : ''}" style="display:none;" required>
                    <div class="error-message"></div>
                </div>
                <div class="InfoListItem">
                    <p>City:
                        <span class="view-mode" th:text="${address != null ? address.city : ''}">City</span>
                    </p>
                    <input class="edit-mode" type="text" name="city"
                           th:value="${address != null ? address.city : ''}" style="display:none;" required>
                    <div class="error-message"></div>
                </div>
                <div class="InfoListItem">
                    <p>ZIP:
                        <span class="view-mode" th:text="${address != null ? address.zip : ''}">12345</span>
                    </p>
                    <input class="edit-mode" type="text" name="zip"
                           th:value="${address != null ? address.zip : ''}" style="display:none;" required
                           pattern="^\d{5}$" placeholder="12345">
                    <div class="error-message"></div>
                </div>
                <div class="InfoListItem">
                    <p>
                        State:
                        <!-- VIEW MODE -->
                        <span class="view-mode"
                              th:text="${address != null && address.state != null ? address.state : 'Select a state'}">State</span>
                    </p>
                    <!-- EDIT MODE DROPDOWN -->
                    <select id="state" name="state" class="edit-mode" style="display:none;" required>
                        <option value="">-- Select State --</option>
                        <option th:each="st : ${states}"
                                th:value="${st.stateCode}"
                                th:text="${st.stateName}"
                                th:selected="${address != null and address.state != null and st.stateCode == address.state}">
                        </option>
                    </select>
                    <div class="error-message"></div>
                </div>
                <div style="height: 20px;"></div>
                <!-- Edit Buttons -->
                <div class="EditButton">
                    <button type="button" id="editBtn">Edit Details</button>
                    <button type="submit" id="saveBtn" style="display:none;">Save All</button>
                    <button type="button" id="cancelBtn" style="display:none;">Cancel</button>
                </div>
            </div>
            <!-- Force edit mode if server-side validation failed -->
            <input type="hidden" th:if="${pinError}" id="forceEditMode" value="true"/>
        </div>
    </form>
    <div class="AppStatus">
        <h2>Application Status:</h2>
        <h2>Incomplete</h2>
    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const editBtn = document.getElementById("editBtn");
    const saveBtn = document.getElementById("saveBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const viewModeElements = document.querySelectorAll(".view-mode");
    const editModeElements = document.querySelectorAll(".edit-mode");

    const pinInput = document.getElementById("editPin");
    const maskedId = document.getElementById("maskedId");
    const togglePassword = document.getElementById("togglePassword");

    // Function to switch to edit mode
    function showEditMode() {
        viewModeElements.forEach(el => el.style.display = "none");
        editModeElements.forEach(el => el.style.display = "inline-block");
        editBtn.style.display = "none";
        saveBtn.style.display = "inline-block";
        cancelBtn.style.display = "inline-block";

        if (maskedId) maskedId.style.display = "none";
    }

    // Function to switch to view mode
    function hideEditMode() {
        viewModeElements.forEach(el => el.style.display = "inline-block");
        editModeElements.forEach(el => el.style.display = "none");
        editBtn.style.display = "inline-block";
        saveBtn.style.display = "none";
        cancelBtn.style.display = "none";

        if (maskedId) {
            maskedId.style.display = "inline-block";
            const last4 = maskedId.getAttribute("data-last4");
            maskedId.textContent = "***-**-" + last4;
        }

        if (pinInput) pinInput.type = "password";
        if (togglePassword) {
            togglePassword.classList.add("bi-eye-slash");
            togglePassword.classList.remove("bi-eye");
        }
    }

    // Eye icon toggle
    if (togglePassword) {
        togglePassword.addEventListener('click', function () {
            if (pinInput.style.display !== "none") {
                pinInput.type = (pinInput.type === "password") ? "text" : "password";
            } else if (maskedId.style.display !== "none") {
                const fullId = maskedId.getAttribute("data-full-id");
                const last4 = maskedId.getAttribute("data-last4");
                maskedId.textContent = maskedId.textContent.includes("***") ? fullId : "***-**-" + last4;
            }
            this.classList.toggle("bi-eye");
            this.classList.toggle("bi-eye-slash");
        });
    }

    editBtn.addEventListener("click", showEditMode);

    cancelBtn.addEventListener("click", function () {
        window.location.href = "/user/user-dashboard";
    });

    if (document.getElementById("forceEditMode")) {
        showEditMode();
    }

    // CLIENT-SIDE VALIDATION
    const form = document.getElementById('userForm');

    // Clear error on input change
    editModeElements.forEach(input => {
        input.addEventListener('input', function () {
            const errorDiv = input.closest('.InfoListItem').querySelector('.error-message');
            if (errorDiv) {
                errorDiv.textContent = '';
                errorDiv.style.display = 'none';
            }
            input.classList.remove('error');
        });
    });

    form.addEventListener('submit', function (e) {
        let valid = true;
        const inputs = form.querySelectorAll('.edit-mode');

        inputs.forEach(input => {
            // Skip hidden inputs
            if (input.offsetParent === null) return;

            const errorDiv = input.closest('.InfoListItem').querySelector('.error-message');
            input.classList.remove('error');
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }

            // Specific validations first
            if (input.name === "pin") {
                if (!/^\d{9}$/.test(input.value)) {
                    valid = false;
                    input.classList.add('error');
                    if (errorDiv) {
                        errorDiv.textContent = 'PIN must be exactly 9 digits.';
                        errorDiv.style.display = 'block';
                    }
                    return; // skip required check for this input
                }
            }

            if (input.name === "state") {
                if (input.value.trim() === '') {
                    valid = false;
                    input.classList.add('error');
                    if (errorDiv) {
                        errorDiv.textContent = 'Please select a state.';
                        errorDiv.style.display = 'block';
                    }
                    return; // skip required check for this input
                }
            }

            // Generic required check for other fields
            if (!input.value.trim()) {
                valid = false;
                input.classList.add('error');
                if (errorDiv) {
                    errorDiv.textContent = 'This field is required.';
                    errorDiv.style.display = 'block';
                }
            }
        });

        if (!valid) e.preventDefault();
    });
});
</script>


</body>
</html>
