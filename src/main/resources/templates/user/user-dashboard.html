<!-- Developed by Darren Wunderlich-->
<!-- Updated by Dana Paquet -->
<!-- v3: Unified User + Address Save -->

<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments :: head}"></head>
<body>
<!-- Navbar -->
<nav>
    <a class="navbar-brand" th:href="@{/user/user-dashboard}">Dashboard</a>
    <a class="navbar-brand" th:href="@{/user/user-employment-verification-form}">Employment Verification</a>
    <a class="nav-link" th:href="@{/user/logout}">Log Out</a>
</nav>

<header>
    <h1>Welcome, <span th:text="${user.firstName}">User</span>!</h1>
</header>

<!-- -------------- FORM TO UPDATE USER + ADDRESS ----------------- -->
<div class="form-container">
    <form id="userForm" th:action="@{/user/user-dashboard/save}" method="post" novalidate>
        <div class="InfoList">
            <!-- User Info -->
            <div class="InfoListCategory">
                <h2>Contact Information:</h2>
                <div class="InfoListItem">
                    <p>Email:
                        <span class="view-mode" th:text="${user.email}">email@example.com</span>
                    </p>
                    <input class="edit-mode" type="email" name="email" th:value="${user.email}" style="display:none;" required>
                    <div class="error-message">Please enter a valid email.</div>
                </div>
                <div class="InfoListItem">
                    <p>Phone:
                        <span class="view-mode" th:text="${user.phone}">(000) 000-0000</span>
                    </p>
                    <input class="edit-mode" type="text" name="phone" th:value="${user.phone}" style="display:none;" required pattern="^\d{10}$" placeholder="1234567890">
                    <div class="error-message">Phone must be 10 digits.</div>
                </div>
            </div>

            <!-- Personal Info -->
            <div class="InfoListCategory">
                <h2>Personal Details:</h2>
                <div class="InfoListItem">
                    <p>First Name:
                        <span class="view-mode" th:text="${user.firstName}">First</span>
                    </p>
                    <input class="edit-mode" type="text" name="firstName" th:value="${user.firstName}" style="display:none;" required>
                    <div class="error-message">First Name is required.</div>
                </div>
                <div class="InfoListItem">
                    <p>Last Name:
                        <span class="view-mode" th:text="${user.lastName}">Last</span>
                    </p>
                    <input class="edit-mode" type="text" name="lastName" th:value="${user.lastName}" style="display:none;" required>
                    <div class="error-message">Last Name is required.</div>
                </div>
                <div class="InfoListItem">
                    <p>Date of Birth:
                        <span class="view-mode" th:text="${#temporals.format(user.dateOfBirth, 'MM/dd/yyyy')}">01/01/1990</span>
                    </p>
                    <input class="edit-mode" type="date" name="dateOfBirth" th:value="${user.dateOfBirth}" style="display:none;" required>
                    <div class="error-message">Date of Birth is required.</div>
                </div>
                <div class="InfoListItem">
                    <p>Personal ID (SSN or ARN):</p>
                    <span id="maskedId" class="masked-id" ondblclick="toggleId()"
                          th:attr="data-full-id=${user.pin}, data-last4=${#strings.substring(user.pin, user.pin.length() - 4)}">
                  ***-**-<span th:text="${#strings.substring(user.pin, user.pin.length() - 4)}">1234</span>
                </span>
                    <input class="edit-mode" type="password" id="editPin" name="pin"
                           th:value="${user.pin}" style="display:none;"
                           required pattern="\d{9}" minlength="9" maxlength="9"
                           title="PIN must be exactly 9 digits. Double-click to show or hide value.">
                    <div class="error-message">PIN must be exactly 9 digits.</div>
                </div>
            </div>

            <!-- Address Fields -->
            <!-- Address Fields -->
            <div class="InfoListCategory">
                <h2>Address:</h2>
                <p th:if="${address == null}" style="color: red; font-weight: bold;">
                    Your address is missing. Please fill in your address below.
                </p>

                <div class="InfoListItem">
                    <p>Street Address:
                        <span class="view-mode" th:text="${address != null ? address.street : ''}">123 Main St</span>
                    </p>
                    <input class="edit-mode" type="text" name="street"
                           th:value="${address != null ? address.street : ''}"
                           style="display:none;" required>
                    <div class="error-message">Street Address is required.</div>
                </div>

                <div class="InfoListItem">
                    <p>City:
                        <span class="view-mode" th:text="${address != null ? address.city : ''}">City</span>
                    </p>
                    <input class="edit-mode" type="text" name="city"
                           th:value="${address != null ? address.city : ''}"
                           style="display:none;" required>
                    <div class="error-message">City is required.</div>
                </div>

                <div class="InfoListItem">
                    <p>ZIP:
                        <span class="view-mode" th:text="${address != null ? address.zip : ''}">12345</span>
                    </p>
                    <input class="edit-mode" type="text" name="zip"
                           th:value="${address != null ? address.zip : ''}"
                           style="display:none;" required pattern="^\d{5}$" placeholder="12345">
                    <div class="error-message">ZIP must be 5 digits.</div>
                </div>

                <div class="InfoListItem">
                    <p>State:
                        <span class="view-mode" th:text="${address != null ? address.state : ''}">State</span>
                    </p>
                    <input class="edit-mode" type="text" name="state"
                           th:value="${address != null ? address.state : ''}"
                           style="display:none;" required>
                    <div class="error-message">State is required.</div>
                </div>
            </div>

            <!-- Edit Buttons -->
            <div class="EditButton">
                <button type="button" id="editBtn">Edit Details</button>
                <button type="submit" id="saveBtn" style="display:none;">Save All</button>
                <button type="button" id="cancelBtn" style="display:none;">Cancel</button>
            </div>
        </div>
    </form>

    <div class="AppStatus">
        <h2>Application Status:</h2>
        <h2>Incomplete</h2>
    </div>
</div>

<script>
    const editBtn = document.getElementById("editBtn");
    const saveBtn = document.getElementById("saveBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const viewModeElements = document.querySelectorAll(".view-mode");
    const editModeElements = document.querySelectorAll(".edit-mode");

    editBtn.addEventListener("click", () => {
        viewModeElements.forEach(el => el.style.display = "none");
        editModeElements.forEach(el => el.style.display = "inline-block");
        editBtn.style.display = "none";
        saveBtn.style.display = "inline-block";
        cancelBtn.style.display = "inline-block";
    });

    cancelBtn.addEventListener("click", () => {
        viewModeElements.forEach(el => el.style.display = "inline-block");
        editModeElements.forEach(el => el.style.display = "none");
        editBtn.style.display = "inline-block";
        saveBtn.style.display = "none";
        cancelBtn.style.display = "none";

        const maskedId = document.getElementById("maskedId");
        const last4 = maskedId.getAttribute("data-last4");
        maskedId.textContent = "***-**-" + last4;
    });

    function toggleId() {
        const maskedId = document.getElementById("maskedId");
        const fullId = maskedId.getAttribute("data-full-id");
        const last4 = maskedId.getAttribute("data-last4");
        if (maskedId.textContent.includes("***")) {
            maskedId.textContent = fullId;
        } else {
            maskedId.textContent = "***-**-" + last4;
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const pinInput = document.getElementById("editPin");
        if (pinInput) {
            pinInput.addEventListener('dblclick', function () {
                pinInput.type = (pinInput.type === 'password') ? 'text' : 'password';
            });
        }

        const form = document.getElementById('userForm');
        form.addEventListener('submit', function (e) {
            let valid = true;
            const inputs = form.querySelectorAll('.edit-mode');
            inputs.forEach(input => {
                const errorDiv = input.nextElementSibling;
                input.classList.remove('error');
                errorDiv.style.display = 'none';

                if (!input.value.trim()) {
                    valid = false;
                    input.classList.add('error');
                    errorDiv.textContent = 'This field is required.';
                    errorDiv.style.display = 'block';
                } else if (input.name === 'email') {
                    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailPattern.test(input.value)) {
                        valid = false;
                        input.classList.add('error');
                        errorDiv.textContent = 'Please enter a valid email.';
                        errorDiv.style.display = 'block';
                    }
                } else if (input.name === 'phone') {
                    const phonePattern = /^\d{10}$/;
                    if (!phonePattern.test(input.value)) {
                        valid = false;
                        input.classList.add('error');
                        errorDiv.textContent = 'Phone must be 10 digits.';
                        errorDiv.style.display = 'block';
                    }
                } else if (input.name === 'pin') {
                    const pinPattern = /^\d{9}$/;
                    if (!pinPattern.test(input.value)) {
                        valid = false;
                        input.classList.add('error');
                        errorDiv.textContent = 'PIN must be exactly 9 digits.';
                        errorDiv.style.display = 'block';
                    }
                } else if (input.name === 'zip') {
                    const zipPattern = /^\d{5}$/;
                    if (!zipPattern.test(input.value)) {
                        valid = false;
                        input.classList.add('error');
                        errorDiv.textContent = 'ZIP must be 5 digits.';
                        errorDiv.style.display = 'block';
                    }
                }
            });

            if (!valid) e.preventDefault();
        });
    });
</script>
</body>
</html>
